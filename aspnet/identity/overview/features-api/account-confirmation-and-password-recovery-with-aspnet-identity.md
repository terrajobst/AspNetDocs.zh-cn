---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: 帐户确认 & 密码恢复-ASP.NET Identity （C#）-ASP.NET 4。x
author: HaoK
description: 在学习本教程之前，应先完成创建具有登录、电子邮件确认和密码重置的安全 ASP.NET MVC 5 web 应用。 本教程 。
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78499982"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="c60e4-104">帐户确认和密码恢复 ASP.NET Identity （C#）</span><span class="sxs-lookup"><span data-stu-id="c60e4-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="c60e4-105">在学习本教程之前，应先完成[创建具有登录、电子邮件确认和密码重置的安全 ASP.NET MVC 5 web 应用](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="c60e4-106">本教程包含更多详细信息，并演示如何设置电子邮件以进行本地帐户确认，并使用户能够在 ASP.NET Identity 中重置其忘记的密码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="c60e4-107">本地用户帐户要求用户为该帐户创建密码，并在 web 应用中存储（安全）该密码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="c60e4-108">ASP.NET Identity 还支持社交帐户，这不需要用户为应用创建密码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="c60e4-109">[社交帐户](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)使用第三方（如 Google、Twitter、Facebook 或 Microsoft）对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="c60e4-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="c60e4-110">本主题涵盖以下内容：</span><span class="sxs-lookup"><span data-stu-id="c60e4-110">This topic covers the following:</span></span>

- <span data-ttu-id="c60e4-111">[创建 ASP.NET MVC 应用](#createMvc)并浏览 ASP.NET Identity 功能。</span><span class="sxs-lookup"><span data-stu-id="c60e4-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="c60e4-112">构建标识示例</span><span class="sxs-lookup"><span data-stu-id="c60e4-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="c60e4-113">设置电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="c60e4-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="c60e4-114">新用户注册其电子邮件别名，这会创建一个本地帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="c60e4-115">选择 "注册" 按钮会向电子邮件地址发送一封包含验证令牌的确认电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="c60e4-116">向用户发送一封电子邮件，其中包含其帐户的确认令牌。</span><span class="sxs-lookup"><span data-stu-id="c60e4-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="c60e4-117">选择该链接即可确认帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="c60e4-118">密码恢复/重置</span><span class="sxs-lookup"><span data-stu-id="c60e4-118">Password recovery/reset</span></span>

<span data-ttu-id="c60e4-119">忘记密码的本地用户可以将安全令牌发送到其电子邮件帐户，从而使他们能够重置其密码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="c60e4-120">用户很快会收到一封电子邮件，其中包含允许用户重置其密码的链接。</span><span class="sxs-lookup"><span data-stu-id="c60e4-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="c60e4-121">选择该链接会将其转到重置页面。</span><span class="sxs-lookup"><span data-stu-id="c60e4-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="c60e4-122">选择 "**重置**" 按钮将确认密码已重置。</span><span class="sxs-lookup"><span data-stu-id="c60e4-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="c60e4-123">创建 ASP.NET Web 应用</span><span class="sxs-lookup"><span data-stu-id="c60e4-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="c60e4-124">首先，安装并运行[Visual Studio 2017](https://visualstudio.microsoft.com/)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="c60e4-125">创建新的 ASP.NET Web 项目，并选择 MVC 模板。</span><span class="sxs-lookup"><span data-stu-id="c60e4-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="c60e4-126">Web 窗体还支持 ASP.NET Identity，因此你可以按照 web 窗体应用程序中的类似步骤进行操作。</span><span class="sxs-lookup"><span data-stu-id="c60e4-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="c60e4-127">更改**单独用户帐户**的身份验证。</span><span class="sxs-lookup"><span data-stu-id="c60e4-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="c60e4-128">运行应用，选择 "**注册**" 链接并注册用户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="c60e4-129">此时，电子邮件的唯一验证是带有[[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性。</span><span class="sxs-lookup"><span data-stu-id="c60e4-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="c60e4-130">在服务器资源管理器中，导航到 "**数据 Connections\DefaultConnection\Tables\AspNetUsers**"，右键单击并选择 "**打开表定义**"。</span><span class="sxs-lookup"><span data-stu-id="c60e4-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="c60e4-131">下图显示了 `AspNetUsers` 架构：</span><span class="sxs-lookup"><span data-stu-id="c60e4-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="c60e4-132">右键单击**AspNetUsers**表，然后选择 "**显示表数据**"。</span><span class="sxs-lookup"><span data-stu-id="c60e4-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="c60e4-133">此时，尚未确认电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="c60e4-134">ASP.NET Identity 的默认数据存储实体框架，但你可以将其配置为使用其他数据存储并添加其他字段。</span><span class="sxs-lookup"><span data-stu-id="c60e4-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="c60e4-135">请参阅本教程末尾的[其他资源](#addRes)部分。</span><span class="sxs-lookup"><span data-stu-id="c60e4-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="c60e4-136">当应用程序启动并调用*应用程序\_Start\Startup.Auth.cs*中的 `ConfigureAuth` 方法时，将调用[OWIN startup 类](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)（ *Startup.cs* ），这会配置 OWIN 管道并初始化 ASP.NET Identity。</span><span class="sxs-lookup"><span data-stu-id="c60e4-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="c60e4-137">检查 `ConfigureAuth` 方法。</span><span class="sxs-lookup"><span data-stu-id="c60e4-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="c60e4-138">每个 `CreatePerOwinContext` 调用都注册一个回调（保存在 `OwinContext`中），将每个请求调用一次该回调以创建指定类型的实例。</span><span class="sxs-lookup"><span data-stu-id="c60e4-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="c60e4-139">您可以在构造函数中设置一个断点，并在每个类型的 `Create` 方法（`ApplicationDbContext, ApplicationUserManager`）中设置一个断点，并验证每个请求是否调用了这些断点。</span><span class="sxs-lookup"><span data-stu-id="c60e4-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="c60e4-140">`ApplicationDbContext` 和 `ApplicationUserManager` 的实例存储在 OWIN 上下文中，可在整个应用程序中对其进行访问。</span><span class="sxs-lookup"><span data-stu-id="c60e4-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="c60e4-141">通过 cookie 中间件 ASP.NET Identity 挂钩到 OWIN 管道。</span><span class="sxs-lookup"><span data-stu-id="c60e4-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="c60e4-142">有关详细信息，请参阅[ASP.NET Identity 中的针对 UserManager 类的每个请求生存期管理](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="c60e4-143">更改安全配置文件时，会生成新的安全戳，并将其存储在*AspNetUsers*表的 `SecurityStamp` 字段中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="c60e4-144">请注意，"`SecurityStamp`" 字段不同于 "安全" cookie。</span><span class="sxs-lookup"><span data-stu-id="c60e4-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="c60e4-145">安全 cookie 不会存储在 `AspNetUsers` 表中（或标识 DB 中的任何其他位置）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="c60e4-146">安全 cookie 令牌使用[DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)自签名，并使用 `UserId, SecurityStamp` 和过期时间信息创建。</span><span class="sxs-lookup"><span data-stu-id="c60e4-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="c60e4-147">Cookie 中间件检查每个请求的 cookie。</span><span class="sxs-lookup"><span data-stu-id="c60e4-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="c60e4-148">`Startup` 类中的 `SecurityStampValidator` 方法将按 `validateInterval`指定的方式，定期访问数据库并检查安全标记。</span><span class="sxs-lookup"><span data-stu-id="c60e4-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="c60e4-149">这种情况仅每30分钟发生一次（在我们的示例中），除非你更改安全配置文件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="c60e4-150">选择了30分钟间隔，以最大程度地减少对数据库的行程。</span><span class="sxs-lookup"><span data-stu-id="c60e4-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="c60e4-151">有关更多详细信息，请参阅我的[双因素身份验证教程](index.md)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="c60e4-152">根据代码中的注释，`UseCookieAuthentication` 方法支持 cookie 身份验证。</span><span class="sxs-lookup"><span data-stu-id="c60e4-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="c60e4-153">`SecurityStamp` 字段和关联代码为应用程序提供了额外的安全层，当你更改密码时，你将从使用登录的浏览器中注销。</span><span class="sxs-lookup"><span data-stu-id="c60e4-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="c60e4-154">使用 `SecurityStampValidator.OnValidateIdentity` 方法，应用程序可以在用户登录时验证安全令牌，这在你更改密码或使用外部登录时使用。</span><span class="sxs-lookup"><span data-stu-id="c60e4-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="c60e4-155">这是为了确保用旧密码生成的任何标记（cookie）失效。</span><span class="sxs-lookup"><span data-stu-id="c60e4-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="c60e4-156">在示例项目中，如果更改用户密码，则会为用户生成一个新的令牌，任何以前的令牌都将失效，并更新 `SecurityStamp` 字段。</span><span class="sxs-lookup"><span data-stu-id="c60e4-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="c60e4-157">标识系统允许配置应用，以便在用户的安全配置文件发生更改时（例如，当用户更改其密码或更改关联的登录名（例如 Facebook、Google、Microsoft 帐户等）时，用户将从所有浏览器实例。</span><span class="sxs-lookup"><span data-stu-id="c60e4-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="c60e4-158">例如，下图显示了[单个 signout 示例](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample)应用程序，该应用程序允许用户通过选择一个按钮，从所有浏览器实例（在本例中为 IE、Firefox 和 Chrome）注销。</span><span class="sxs-lookup"><span data-stu-id="c60e4-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="c60e4-159">此外，该示例还允许您仅注销特定的浏览器实例。</span><span class="sxs-lookup"><span data-stu-id="c60e4-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="c60e4-160">[单个 signout 示例](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample)应用程序演示了 ASP.NET Identity 如何允许您重新生成安全令牌。</span><span class="sxs-lookup"><span data-stu-id="c60e4-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="c60e4-161">这是为了确保用旧密码生成的任何标记（cookie）失效。</span><span class="sxs-lookup"><span data-stu-id="c60e4-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="c60e4-162">此功能为应用程序提供了额外的安全层;当你更改密码时，你将被注销，你已登录到此应用程序。</span><span class="sxs-lookup"><span data-stu-id="c60e4-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="c60e4-163">*应用\_Start\IdentityConfig.cs*文件包含 `ApplicationUserManager`、`EmailService` 和 `SmsService` 类。</span><span class="sxs-lookup"><span data-stu-id="c60e4-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="c60e4-164">`EmailService` 和 `SmsService` 类都实现了 `IIdentityMessageService` 接口，因此，每个类中都有一些公共方法来配置电子邮件和短信。</span><span class="sxs-lookup"><span data-stu-id="c60e4-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="c60e4-165">虽然本教程仅介绍了如何通过[SendGrid](http://sendgrid.com/)添加电子邮件通知，但你可以使用 SMTP 和其他机制发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="c60e4-166">`Startup` 类还包含样板板式来添加社交登录（Facebook、Twitter 等），请参阅我的教程适用于[facebook、twitter、LinkedIn 和 Google OAuth2 登录的 MVC 5 应用](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)以获取详细信息。</span><span class="sxs-lookup"><span data-stu-id="c60e4-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="c60e4-167">检查包含用户标识信息的 `ApplicationUserManager` 类，并配置以下功能：</span><span class="sxs-lookup"><span data-stu-id="c60e4-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="c60e4-168">密码强度要求。</span><span class="sxs-lookup"><span data-stu-id="c60e4-168">Password strength requirements.</span></span>
- <span data-ttu-id="c60e4-169">用户锁定（尝试和时间）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="c60e4-170">双因素身份验证（2FA）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="c60e4-171">我将在另一个教程中介绍2FA 和 SMS。</span><span class="sxs-lookup"><span data-stu-id="c60e4-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="c60e4-172">挂接电子邮件和 SMS 服务。</span><span class="sxs-lookup"><span data-stu-id="c60e4-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="c60e4-173">（我将在另一个教程中介绍短信）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="c60e4-174">`ApplicationUserManager` 类派生自泛型 `UserManager<ApplicationUser>` 类。</span><span class="sxs-lookup"><span data-stu-id="c60e4-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="c60e4-175">`ApplicationUser` 派生自[IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="c60e4-176">`IdentityUser` 派生自泛型 `IdentityUser` 类：</span><span class="sxs-lookup"><span data-stu-id="c60e4-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="c60e4-177">上面所示的属性与 `AspNetUsers` 表中的属性一致。</span><span class="sxs-lookup"><span data-stu-id="c60e4-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="c60e4-178">`IUser` 上的泛型参数使你能够使用不同的主键类型来派生类。</span><span class="sxs-lookup"><span data-stu-id="c60e4-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="c60e4-179">请参阅[ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK)示例，该示例演示如何将主密钥从 string 更改为 INT 或 GUID。</span><span class="sxs-lookup"><span data-stu-id="c60e4-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="c60e4-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="c60e4-180">ApplicationUser</span></span>

<span data-ttu-id="c60e4-181">`ApplicationUser` （`public class ApplicationUserManager : UserManager<ApplicationUser>`）在*Models\IdentityModels.cs*中定义为：</span><span class="sxs-lookup"><span data-stu-id="c60e4-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="c60e4-182">上面突出显示的代码生成[ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="c60e4-183">ASP.NET Identity 和 OWIN Cookie 身份验证是基于声明的，因此框架要求应用为用户生成 `ClaimsIdentity`。</span><span class="sxs-lookup"><span data-stu-id="c60e4-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="c60e4-184">`ClaimsIdentity` 包含有关用户的所有声明的信息，如用户的姓名、年龄和用户所属的角色。</span><span class="sxs-lookup"><span data-stu-id="c60e4-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="c60e4-185">你还可以在此阶段为用户添加更多声明。</span><span class="sxs-lookup"><span data-stu-id="c60e4-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="c60e4-186">OWIN `AuthenticationManager.SignIn` 方法传入 `ClaimsIdentity` 并在用户登录：</span><span class="sxs-lookup"><span data-stu-id="c60e4-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="c60e4-187">[带有 Facebook、Twitter、LinkedIn 和 Google OAuth2 登录的 MVC 5 应用](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)显示了如何将其他属性添加到 `ApplicationUser` 类。</span><span class="sxs-lookup"><span data-stu-id="c60e4-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="c60e4-188">电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="c60e4-188">Email confirmation</span></span>

<span data-ttu-id="c60e4-189">最好确认电子邮件中新用户注册的电子邮件，以验证它们是否未模拟其他用户（即，他们未注册其他人的电子邮件）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="c60e4-190">假设你有讨论论坛，则需要防止 `"bob@example.com"` 注册为 `"joe@contoso.com"`。</span><span class="sxs-lookup"><span data-stu-id="c60e4-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="c60e4-191">如果未确认电子邮件，`"joe@contoso.com"` 可能会从你的应用收到不需要的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="c60e4-192">假设 Bob 意外注册为 `"bib@example.com"` 并且未注意到，他无法使用密码恢复，因为该应用没有正确的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="c60e4-193">电子邮件确认仅提供对 bot 的有限保护，不提供对已确定垃圾邮件发送者的保护，它们具有可用于注册的许多工作电子邮件别名。在下面的示例中，用户将无法更改其密码，直到其帐户被确认之后（他们选择在其注册的电子邮件帐户上收到的确认链接）。你可以将此工作流应用于其他方案，例如发送链接以在管理员创建的新帐户上确认并重置密码，并在用户更改其配置文件后向用户发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="c60e4-194">通常，在通过电子邮件、短信或其他机制确认新用户之前，要阻止新用户将任何数据发布到您的网站。</span><span class="sxs-lookup"><span data-stu-id="c60e4-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="c60e4-195">生成更完整的示例</span><span class="sxs-lookup"><span data-stu-id="c60e4-195">Build a more complete sample</span></span>

<span data-ttu-id="c60e4-196">在本部分中，你将使用 NuGet 下载我们将使用的更完整的示例。</span><span class="sxs-lookup"><span data-stu-id="c60e4-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="c60e4-197">创建新的***空***ASP.NET Web 项目。</span><span class="sxs-lookup"><span data-stu-id="c60e4-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="c60e4-198">在 "程序包管理器控制台" 中，输入以下命令：</span><span class="sxs-lookup"><span data-stu-id="c60e4-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="c60e4-199">在本教程中，我们将使用[SendGrid](http://sendgrid.com/)发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="c60e4-200">`Identity.Samples` 包将安装要使用的代码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="c60e4-201">将[项目设置为使用 SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="c60e4-202">通过运行应用、选择 "**注册**" 链接并发布注册表单来测试本地帐户创建。</span><span class="sxs-lookup"><span data-stu-id="c60e4-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="c60e4-203">选择 "演示电子邮件" 链接，该链接模拟电子邮件确认。</span><span class="sxs-lookup"><span data-stu-id="c60e4-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="c60e4-204">从示例中删除演示电子邮件链接确认代码（帐户控制器中的 `ViewBag.Link` 代码。</span><span class="sxs-lookup"><span data-stu-id="c60e4-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="c60e4-205">请参阅 `DisplayEmail` 和 `ForgotPasswordConfirmation` 操作方法和 razor 视图）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="c60e4-206">如果更改此示例中的任何安全设置，则生产应用将需要进行安全审核，以显式调用所做的更改。</span><span class="sxs-lookup"><span data-stu-id="c60e4-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="c60e4-207">检查应用\_Start\IdentityConfig.cs 中的代码</span><span class="sxs-lookup"><span data-stu-id="c60e4-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="c60e4-208">此示例演示如何创建帐户并将其添加到*管理员*角色。</span><span class="sxs-lookup"><span data-stu-id="c60e4-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="c60e4-209">应该将示例中的电子邮件替换为要用于管理员帐户的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="c60e4-210">最简单的方法是以编程方式在 `Seed` 方法中创建管理员帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="c60e4-211">我们希望在将来使用一种工具来创建和管理用户和角色。</span><span class="sxs-lookup"><span data-stu-id="c60e4-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="c60e4-212">示例代码允许您创建和管理用户和角色，但您必须首先使用管理员帐户来运行角色和用户管理页面。</span><span class="sxs-lookup"><span data-stu-id="c60e4-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="c60e4-213">在此示例中，在对数据库进行种子设定时，将创建管理员帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="c60e4-214">更改密码，并将名称更改为可接收电子邮件通知的帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="c60e4-215">安全性-永远不要将敏感数据存储在源代码中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="c60e4-216">如前所述，startup 类中的 `app.CreatePerOwinContext` 调用会将回调添加到应用数据库内容、用户管理器和角色管理器类的 `Create` 方法。</span><span class="sxs-lookup"><span data-stu-id="c60e4-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="c60e4-217">OWIN 管道为每个请求调用这些类的 `Create` 方法，并存储每个类的上下文。</span><span class="sxs-lookup"><span data-stu-id="c60e4-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="c60e4-218">帐户控制器通过 HTTP 上下文公开用户管理器（其中包含 OWIN 上下文）：</span><span class="sxs-lookup"><span data-stu-id="c60e4-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="c60e4-219">当用户注册本地帐户时，将调用 `HTTP Post Register` 方法：</span><span class="sxs-lookup"><span data-stu-id="c60e4-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="c60e4-220">上面的代码使用模型数据，通过输入的电子邮件和密码来创建新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="c60e4-221">如果电子邮件别名在数据存储中，则帐户创建将失败，并再次显示表单。</span><span class="sxs-lookup"><span data-stu-id="c60e4-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="c60e4-222">`GenerateEmailConfirmationTokenAsync` 方法创建安全确认令牌并将其存储在 ASP.NET Identity 数据存储中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="c60e4-223">[Url。 Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)方法创建包含 `UserId` 和确认令牌的链接。</span><span class="sxs-lookup"><span data-stu-id="c60e4-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="c60e4-224">然后，可以通过电子邮件向用户发送此链接，用户可以在其电子邮件应用的链接上选择，以确认其帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="c60e4-225">设置电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="c60e4-225">Set up email confirmation</span></span>

<span data-ttu-id="c60e4-226">请参阅[Azure SendGrid 注册页](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)并注册免费帐户。</span><span class="sxs-lookup"><span data-stu-id="c60e4-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="c60e4-227">添加类似于下面的代码以配置 SendGrid：</span><span class="sxs-lookup"><span data-stu-id="c60e4-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="c60e4-228">电子邮件客户端通常只接受短信（无 HTML）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="c60e4-229">应提供文本和 HTML 格式的消息。</span><span class="sxs-lookup"><span data-stu-id="c60e4-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="c60e4-230">在上面的 SendGrid 示例中，此操作是通过上面所示的 `myMessage.Text` 和 `myMessage.Html` 代码完成的。</span><span class="sxs-lookup"><span data-stu-id="c60e4-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="c60e4-231">下面的代码演示如何使用[send-mailmessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)类发送电子邮件，其中 `message.Body` 仅返回链接。</span><span class="sxs-lookup"><span data-stu-id="c60e4-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="c60e4-232">安全性-永远不要将敏感数据存储在源代码中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="c60e4-233">帐户和凭据存储在 appSetting 中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="c60e4-234">在 Azure 上，可以将这些值安全地存储在 Azure 门户中的 " **[配置](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** " 选项卡上。</span><span class="sxs-lookup"><span data-stu-id="c60e4-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="c60e4-235">请参阅[将密码和其他敏感数据部署到 ASP.NET 和 Azure 的最佳做法](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="c60e4-236">输入你的 SendGrid 凭据，运行应用，使用电子邮件别名进行注册可以选择电子邮件中的 "确认" 链接。</span><span class="sxs-lookup"><span data-stu-id="c60e4-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="c60e4-237">若要查看如何通过[Outlook.com](http://outlook.com)电子邮件帐户执行此操作，请参阅 John Atten 的[ C# Outlook.Com smtp 主机的 smtp 配置](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)和他的[ASP.NET Identity 2.0：设置帐户验证和双重身份验证](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)发布。</span><span class="sxs-lookup"><span data-stu-id="c60e4-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="c60e4-238">用户选择 "**注册**" 按钮后，将会向电子邮件地址发送一封包含验证令牌的确认电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c60e4-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="c60e4-239">向用户发送一封电子邮件，其中包含其帐户的确认令牌。</span><span class="sxs-lookup"><span data-stu-id="c60e4-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="c60e4-240">检查代码</span><span class="sxs-lookup"><span data-stu-id="c60e4-240">Examine the code</span></span>

<span data-ttu-id="c60e4-241">以下代码演示了 `POST ForgotPassword` 方法。</span><span class="sxs-lookup"><span data-stu-id="c60e4-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="c60e4-242">如果未确认用户电子邮件，则该方法将以无提示方式失败。</span><span class="sxs-lookup"><span data-stu-id="c60e4-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="c60e4-243">如果针对无效电子邮件地址发布了错误，恶意用户可能会使用这些信息来查找有效的 userId （电子邮件别名）以进行攻击。</span><span class="sxs-lookup"><span data-stu-id="c60e4-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="c60e4-244">下面的代码显示帐户控制器中的 `ConfirmEmail` 方法，当用户在发送给他们的电子邮件中选择确认链接时，将调用该方法：</span><span class="sxs-lookup"><span data-stu-id="c60e4-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="c60e4-245">使用忘记的密码令牌后，它会失效。</span><span class="sxs-lookup"><span data-stu-id="c60e4-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="c60e4-246">`Create` 方法中的以下代码更改（在*应用\_Start\IdentityConfig.cs*文件中）将令牌设置为3小时后过期。</span><span class="sxs-lookup"><span data-stu-id="c60e4-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="c60e4-247">在上面的代码中，忘记的密码和电子邮件确认令牌将在3小时后过期。</span><span class="sxs-lookup"><span data-stu-id="c60e4-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="c60e4-248">默认 `TokenLifespan` 为一天。</span><span class="sxs-lookup"><span data-stu-id="c60e4-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="c60e4-249">以下代码显示电子邮件确认方法：</span><span class="sxs-lookup"><span data-stu-id="c60e4-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="c60e4-250">为了使应用更安全，ASP.NET Identity 支持双因素身份验证（2FA）。</span><span class="sxs-lookup"><span data-stu-id="c60e4-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="c60e4-251">请参阅[ASP.NET Identity 2.0：通过 John Atten 设置帐户验证和双重身份验证](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="c60e4-252">虽然你可以在登录密码尝试失败时设置帐户锁定，但该方法会使你的登录容易受到[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)锁定。</span><span class="sxs-lookup"><span data-stu-id="c60e4-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="c60e4-253">建议仅将帐户锁定用于2FA。</span><span class="sxs-lookup"><span data-stu-id="c60e4-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="c60e4-254">其他资源</span><span class="sxs-lookup"><span data-stu-id="c60e4-254">Additional resources</span></span>

- [<span data-ttu-id="c60e4-255">ASP.NET 标识的自定义存储提供程序概述</span><span class="sxs-lookup"><span data-stu-id="c60e4-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="c60e4-256">[带有 Facebook、Twitter、LinkedIn 和 Google OAuth2 登录的 MVC 5 应用程序](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)还演示如何将配置文件信息添加到用户表中。</span><span class="sxs-lookup"><span data-stu-id="c60e4-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="c60e4-257">[ASP.NET MVC 和 Identity 2.0：了解 John Atten 的基础知识](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c60e4-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="c60e4-258">ASP.NET 标识简介</span><span class="sxs-lookup"><span data-stu-id="c60e4-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="c60e4-259">[公告 ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) By Pranav RASTOGI 撰写的 RTM。</span><span class="sxs-lookup"><span data-stu-id="c60e4-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
