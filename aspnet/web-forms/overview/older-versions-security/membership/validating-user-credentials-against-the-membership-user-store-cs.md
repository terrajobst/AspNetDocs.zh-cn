---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
title: 针对成员身份用户存储（C#）验证用户凭据 |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将介绍如何使用编程方式和登录控件 ... 为成员身份用户存储验证用户凭据。
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 61aa4e08-aa81-4aeb-8ebe-19ba7a65e04c
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
msc.type: authoredcontent
ms.openlocfilehash: aaf6df6f52253ef0f7369a7e77211b6786b97db1
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74618051"
---
# <a name="validating-user-credentials-against-the-membership-user-store-c"></a><span data-ttu-id="d2b52-103">针对成员身份用户存储验证用户凭据 (C#)</span><span class="sxs-lookup"><span data-stu-id="d2b52-103">Validating User Credentials Against the Membership User Store (C#)</span></span>

<span data-ttu-id="d2b52-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d2b52-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d2b52-105">[下载代码](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip)或[下载 PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="d2b52-105">[Download Code](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip) or [Download PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span></span>

> <span data-ttu-id="d2b52-106">在本教程中，我们将介绍如何使用编程方式和登录控件验证用户凭据与成员资格用户存储。</span><span class="sxs-lookup"><span data-stu-id="d2b52-106">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="d2b52-107">我们还将介绍如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="d2b52-107">We will also look at how to customize the login control's appearance and behavior.</span></span>

## <a name="introduction"></a><span data-ttu-id="d2b52-108">简介</span><span class="sxs-lookup"><span data-stu-id="d2b52-108">Introduction</span></span>

<span data-ttu-id="d2b52-109">在<a id="Tutorial05"> </a>[前面的教程](creating-user-accounts-cs.md)中，我们介绍了如何在成员身份框架中创建新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="d2b52-109">In the <a id="Tutorial05"></a>[preceding tutorial](creating-user-accounts-cs.md) we looked at how to create a new user account in the Membership framework.</span></span> <span data-ttu-id="d2b52-110">首先，我们将了解如何通过 `Membership` 类的 `CreateUser` 方法以编程方式创建用户帐户，然后使用 CreateUserWizard Web 控件进行检查。</span><span class="sxs-lookup"><span data-stu-id="d2b52-110">We first looked at programmatically creating user accounts via the `Membership` class's `CreateUser` method, and then examined using the CreateUserWizard Web control.</span></span> <span data-ttu-id="d2b52-111">但是，登录页当前根据用户名和密码对的硬编码列表对提供的凭据进行验证。</span><span class="sxs-lookup"><span data-stu-id="d2b52-111">However, the login page currently validates the supplied credentials against a hard-coded list of username and password pairs.</span></span> <span data-ttu-id="d2b52-112">我们需要更新登录页的逻辑，以便它根据成员身份框架的用户存储区来验证凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-112">We need to update the login page's logic so that it validates credentials against the Membership framework's user store.</span></span>

<span data-ttu-id="d2b52-113">与创建用户帐户非常类似，可以通过编程方式或声明方式验证凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-113">Much like with creating user accounts, credentials can be validated programmatically or declaratively.</span></span> <span data-ttu-id="d2b52-114">成员资格 API 包含一个方法，用于以编程方式根据用户存储区来验证用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-114">The Membership API includes a method for programmatically validating a user's credentials against the user store.</span></span> <span data-ttu-id="d2b52-115">和 ASP.NET 随登录 Web 控件一起提供，后者使用用户名和密码的文本框以及用于登录的按钮来呈现用户界面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-115">And ASP.NET ships with the Login Web control, which renders a user interface with textboxes for the username and password and a button to log in.</span></span>

<span data-ttu-id="d2b52-116">在本教程中，我们将介绍如何使用编程方式和登录控件验证用户凭据与成员资格用户存储。</span><span class="sxs-lookup"><span data-stu-id="d2b52-116">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="d2b52-117">我们还将介绍如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="d2b52-117">We will also look at how to customize the login control's appearance and behavior.</span></span> <span data-ttu-id="d2b52-118">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="d2b52-118">Let's get started!</span></span>

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a><span data-ttu-id="d2b52-119">步骤1：根据成员身份用户存储验证凭据</span><span class="sxs-lookup"><span data-stu-id="d2b52-119">Step 1: Validating Credentials Against the Membership User Store</span></span>

<span data-ttu-id="d2b52-120">对于使用 forms 身份验证的网站，用户可以通过访问登录页面并输入其凭据登录到网站。</span><span class="sxs-lookup"><span data-stu-id="d2b52-120">For web sites that use forms authentication, a user logs on to the website by visiting a login page and entering their credentials.</span></span> <span data-ttu-id="d2b52-121">然后，将这些凭据与用户存储进行比较。</span><span class="sxs-lookup"><span data-stu-id="d2b52-121">These credentials are then compared against the user store.</span></span> <span data-ttu-id="d2b52-122">如果这些凭据有效，则向用户授予 forms 身份验证票证，这是一个指示访问者身份和身份验证的安全令牌。</span><span class="sxs-lookup"><span data-stu-id="d2b52-122">If they are valid, then the user is granted a forms authentication ticket, which is a security token that indicates the identity and authenticity of the visitor.</span></span>

<span data-ttu-id="d2b52-123">若要针对成员身份框架验证用户，请使用 `Membership` 类的[`ValidateUser` 方法](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="d2b52-123">To validate a user against the Membership framework, use the `Membership` class's [`ValidateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx).</span></span> <span data-ttu-id="d2b52-124">`ValidateUser` 方法采用两个输入参数- *`username`* 和 *`password`* ，并返回一个布尔值，指示凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-124">The `ValidateUser` method takes in two input parameters - *`username`* and *`password`* - and returns a Boolean value indicating whether the credentials were valid.</span></span> <span data-ttu-id="d2b52-125">与我们在上一教程中所述的 `CreateUser` 方法类似，`ValidateUser` 方法将实际验证委托给已配置的成员资格提供程序。</span><span class="sxs-lookup"><span data-stu-id="d2b52-125">Like with the `CreateUser` method we examined in the previous tutorial, the `ValidateUser` method delegates the actual validation to the configured Membership provider.</span></span>

<span data-ttu-id="d2b52-126">`SqlMembershipProvider` 通过 `aspnet_Membership_GetPasswordWithFormat` 存储过程获取指定用户的密码来验证提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-126">The `SqlMembershipProvider` validates the supplied credentials by obtaining the specified user's password via the `aspnet_Membership_GetPasswordWithFormat` stored procedure.</span></span> <span data-ttu-id="d2b52-127">回忆一下，`SqlMembershipProvider` 使用以下三种格式之一来存储用户密码：明文、加密或哈希。</span><span class="sxs-lookup"><span data-stu-id="d2b52-127">Recall that the `SqlMembershipProvider` stores users' passwords using one of three formats: clear, encrypted, or hashed.</span></span> <span data-ttu-id="d2b52-128">`aspnet_Membership_GetPasswordWithFormat` 存储过程以原始格式返回密码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-128">The `aspnet_Membership_GetPasswordWithFormat` stored procedure returns the password in its raw format.</span></span> <span data-ttu-id="d2b52-129">对于加密或哈希密码，`SqlMembershipProvider` 会将传入 `ValidateUser` 方法的 *`password`* 值转换为其等效的加密或哈希状态，然后将其与从数据库中返回的内容进行比较。</span><span class="sxs-lookup"><span data-stu-id="d2b52-129">For encrypted or hashed passwords, the `SqlMembershipProvider` transforms the *`password`* value passed into the `ValidateUser` method into its equivalent encrypted or hashed state and then compares it with what was returned from the database.</span></span> <span data-ttu-id="d2b52-130">如果存储在数据库中的密码与用户输入的格式化密码相匹配，则凭据有效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-130">If the password stored in the database matches the formatted password entered by the user, the credentials are valid.</span></span>

<span data-ttu-id="d2b52-131">让我们更新登录页（~/`Login.aspx`），以便它根据成员身份框架用户存储验证提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-131">Let's update our login page (~/`Login.aspx`) so that it validates the supplied credentials against the Membership framework user store.</span></span> <span data-ttu-id="d2b52-132">我们在<a id="Tutorial02"> </a>[*窗体身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中创建了此登录页，并创建了一个包含两个文本框的 "用户名" 和 "密码" 文本框、"记住我" 复选框和一个 "登录" 按钮（参见图1）。</span><span class="sxs-lookup"><span data-stu-id="d2b52-132">We created this login page back in the <a id="Tutorial02"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, creating an interface with two TextBoxes for the username and password, a Remember Me checkbox, and a Login button (see Figure 1).</span></span> <span data-ttu-id="d2b52-133">此代码根据用户名和密码对的硬编码列表（Scott/密码、Jisun/密码和 Sam/密码）来验证输入的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-133">The code validates the entered credentials against a hard-coded list of username and password pairs (Scott/password, Jisun/password, and Sam/password).</span></span> <span data-ttu-id="d2b52-134"><a id="Tutorial03"></a>在[*forms 身份验证配置和高级主题*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md)教程中，我们更新了登录页的代码，以将其他信息存储在 Forms 身份验证票证的 `UserData` 属性中。</span><span class="sxs-lookup"><span data-stu-id="d2b52-134">In the <a id="Tutorial03"></a>[*Forms Authentication Configuration and Advanced Topics*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) tutorial we updated the login page's code to store additional information in the forms authentication ticket's `UserData` property.</span></span>

<span data-ttu-id="d2b52-135">[登录页的接口 ![包括两个文本框、一个 CheckBoxList 和一个按钮](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-135">[![The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span></span>

<span data-ttu-id="d2b52-136">**图 1**：登录页的接口包括两个文本框：一个 CheckBoxList 和一个按钮（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-136">**Figure 1**: The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))</span></span>

<span data-ttu-id="d2b52-137">登录页的用户界面可以保持不变，但我们需要将登录按钮的 `Click` 事件处理程序替换为针对成员身份框架用户存储验证用户的代码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-137">The login page's user interface can remain unchanged, but we need to replace the Login button's `Click` event handler with code that validates the user against the Membership framework user store.</span></span> <span data-ttu-id="d2b52-138">更新事件处理程序，使其代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="d2b52-138">Update the event handler so that its code appears as follows:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample1.cs)]

<span data-ttu-id="d2b52-139">此代码非常简单。</span><span class="sxs-lookup"><span data-stu-id="d2b52-139">This code is remarkably simple.</span></span> <span data-ttu-id="d2b52-140">首先，我们调用 `Membership.ValidateUser` 方法，并传入提供的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-140">We start by calling the `Membership.ValidateUser` method, passing in the supplied username and password.</span></span> <span data-ttu-id="d2b52-141">如果该方法返回 true，则用户通过 `FormsAuthentication` 类的 Formsauthentication.redirectfromloginpage 方法登录到网站。</span><span class="sxs-lookup"><span data-stu-id="d2b52-141">If that method returns true, then the user is signed into the site via the `FormsAuthentication` class's RedirectFromLoginPage method.</span></span> <span data-ttu-id="d2b52-142">（如我们在<a id="Tutorial2"> </a> [*Forms 身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中所述，`FormsAuthentication.RedirectFromLoginPage` 会创建 forms 身份验证票证，然后将用户重定向到适当的页面。）但是，如果凭据无效，则会显示 `InvalidCredentialsMessage` 标签，通知用户其用户名或密码不正确。</span><span class="sxs-lookup"><span data-stu-id="d2b52-142">(As we discussed in the <a id="Tutorial2"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, the `FormsAuthentication.RedirectFromLoginPage` creates the forms authentication ticket and then redirects the user to the appropriate page.) If the credentials are invalid, however, the `InvalidCredentialsMessage` Label is displayed, informing the user that their username or password was incorrect.</span></span>

<span data-ttu-id="d2b52-143">就这么简单！</span><span class="sxs-lookup"><span data-stu-id="d2b52-143">That's all there is to it!</span></span>

<span data-ttu-id="d2b52-144">若要测试登录页面是否按预期运行，请尝试使用在前面的教程中创建的用户帐户之一登录。</span><span class="sxs-lookup"><span data-stu-id="d2b52-144">To test that the login page works as expected, attempt to login with one of the user accounts you created in the preceding tutorial.</span></span> <span data-ttu-id="d2b52-145">或者，如果尚未创建帐户，请继续从 "`~/Membership/CreatingUserAccounts.aspx`" 页中创建一个帐户。</span><span class="sxs-lookup"><span data-stu-id="d2b52-145">Or, if you have not yet created an account, go ahead and create one from the `~/Membership/CreatingUserAccounts.aspx` page.</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-146">当用户输入其凭据并提交登录页表单时，凭据（包括她的密码）将通过 Internet 以*纯文本*形式传输到 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="d2b52-146">When the user enters her credentials and submits the login page form, the credentials, including her password, are transmitted over the Internet to the web server in *plain text*.</span></span> <span data-ttu-id="d2b52-147">这意味着任何黑客探查网络流量都能看到用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-147">That means any hacker sniffing the network traffic can see the username and password.</span></span> <span data-ttu-id="d2b52-148">若要防止出现这种情况，必须使用[安全套接字层（SSL）](http://en.wikipedia.org/wiki/Secure_Sockets_Layer)加密网络流量。</span><span class="sxs-lookup"><span data-stu-id="d2b52-148">To prevent this, it is essential to encrypt the network traffic by using [Secure Socket Layers (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer).</span></span> <span data-ttu-id="d2b52-149">这将确保在 web 服务器接收到浏览器之前，会对凭据（以及整页的 HTML 标记）进行加密。</span><span class="sxs-lookup"><span data-stu-id="d2b52-149">This will ensure that the credentials (as well as the entire page's HTML markup) are encrypted from the moment they leave the browser until they are received by the web server.</span></span>

### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a><span data-ttu-id="d2b52-150">成员资格框架如何处理无效的登录尝试</span><span class="sxs-lookup"><span data-stu-id="d2b52-150">How the Membership Framework Handles Invalid Login Attempts</span></span>

<span data-ttu-id="d2b52-151">当访问者到达登录页面并提交其凭据时，他们的浏览器会向登录页发出 HTTP 请求。</span><span class="sxs-lookup"><span data-stu-id="d2b52-151">When a visitor reaches the login page and submits their credentials, their browser makes an HTTP request to the login page.</span></span> <span data-ttu-id="d2b52-152">如果凭据有效，HTTP 响应将在 cookie 中包含身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="d2b52-152">If the credentials are valid, the HTTP response includes the authentication ticket in a cookie.</span></span> <span data-ttu-id="d2b52-153">因此，尝试侵入网站的黑客可能会创建一个程序，该程序使用有效的用户名并在密码上猜测来向登录页发送 HTTP 请求。</span><span class="sxs-lookup"><span data-stu-id="d2b52-153">Therefore, a hacker attempting to break into your site could create a program that exhaustively sends HTTP requests to the login page with a valid username and a guess at the password.</span></span> <span data-ttu-id="d2b52-154">如果密码推测正确，则登录页将返回身份验证票证 cookie，此时程序知道该 cookie 已跌倒有效的用户名/密码对。</span><span class="sxs-lookup"><span data-stu-id="d2b52-154">If the password guess is correct, the login page will return the authentication ticket cookie, at which point the program knows it has stumbled upon a valid username/password pair.</span></span> <span data-ttu-id="d2b52-155">通过暴力破解，此类程序可能能够碰到用户密码，尤其是在密码较弱的情况下。</span><span class="sxs-lookup"><span data-stu-id="d2b52-155">Through brute force, such a program might be able to stumble upon a user's password, especially if the password is weak.</span></span>

<span data-ttu-id="d2b52-156">若要防止这种暴力攻击，成员身份框架会锁定用户，前提是在某个时间段内有一定次数的失败登录尝试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-156">To prevent such brute force attacks, the Membership framework locks out a user if there are a certain number of unsuccessful login attempts within a certain period of time.</span></span> <span data-ttu-id="d2b52-157">可以通过以下两个成员资格提供程序配置设置来配置确切的参数：</span><span class="sxs-lookup"><span data-stu-id="d2b52-157">The exact parameters are configurable through the following two Membership provider configuration settings:</span></span>

- <span data-ttu-id="d2b52-158">`maxInvalidPasswordAttempts`-指定用户在帐户被锁定之前的时间段内允许多少次无效密码尝试。默认值为5。</span><span class="sxs-lookup"><span data-stu-id="d2b52-158">`maxInvalidPasswordAttempts` - specifies how many invalid password attempts are allowed for the user within the time period before the account is locked out. The default value is 5.</span></span>
- <span data-ttu-id="d2b52-159">`passwordAttemptWindow`-表示指定的无效登录尝试次数将导致帐户被锁定的时间段，以分钟为单位。默认值为10。</span><span class="sxs-lookup"><span data-stu-id="d2b52-159">`passwordAttemptWindow` - indicates the time period in minutes during which the specified number of invalid login attempts will cause the account to be locked out. The default value is 10.</span></span>

<span data-ttu-id="d2b52-160">如果用户已被锁定，她将无法登录，直到管理员解锁其帐户。</span><span class="sxs-lookup"><span data-stu-id="d2b52-160">If a user has been locked out, she cannot login until an administrator unlocks her account.</span></span> <span data-ttu-id="d2b52-161">锁定用户时，`ValidateUser` 方法将*始终*返回 `false`，即使提供了有效凭据也是如此。</span><span class="sxs-lookup"><span data-stu-id="d2b52-161">When a user is locked out, the `ValidateUser` method will *always* return `false`, even if valid credentials are supplied.</span></span> <span data-ttu-id="d2b52-162">尽管此行为降低了黑客通过暴力破解方法进入你的站点的可能性，但最终最终会锁定一个有效的用户，该用户只是忘记了自己的密码，或者无意中出现了 Caps Lock 或出现了错误的键入日期。</span><span class="sxs-lookup"><span data-stu-id="d2b52-162">While this behavior lessens the likelihood that a hacker will break into your site through brute force methods, it can end up locking out a valid user who has simply forgotten her password or accidentally has the Caps Lock on or is having a bad typing day.</span></span>

<span data-ttu-id="d2b52-163">遗憾的是，没有用于解锁用户帐户的内置工具。</span><span class="sxs-lookup"><span data-stu-id="d2b52-163">Unfortunately, there is no built-in tool for unlocking a user account.</span></span> <span data-ttu-id="d2b52-164">为了解除帐户锁定，你可以直接修改数据库，将 `aspnet_Membership` 表中的 "`IsLockedOut`" 字段更改为相应的用户帐户，或者创建一个基于 web 的界面，其中列出已锁定的帐户，其中包含用于解锁它们的选项。</span><span class="sxs-lookup"><span data-stu-id="d2b52-164">In order to unlock an account, you can modify the database directly - change the `IsLockedOut` field in the `aspnet_Membership` table for the appropriate user account - or create a web-based interface that lists locked out accounts with options to unlock them.</span></span> <span data-ttu-id="d2b52-165">在将来的教程中，我们将介绍如何创建用于完成常见用户帐户和与角色相关任务的管理界面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-165">We will examine creating administrative interfaces for accomplishing common user account- and role-related tasks in a future tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-166">`ValidateUser` 方法的一个缺点是，当提供的凭据无效时，它不会提供任何有关原因的解释。</span><span class="sxs-lookup"><span data-stu-id="d2b52-166">One downside of the `ValidateUser` method is that when the supplied credentials are invalid, it does not provide any explanation as to why.</span></span> <span data-ttu-id="d2b52-167">凭据可能无效，因为用户存储区中没有匹配的用户名/密码对，或者用户尚未获得批准，或用户已被锁定。在步骤4中，我们将了解如何在登录尝试失败时向用户显示更详细的消息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-167">The credentials may be invalid because there is no matching username/password pair in the user store, or because the user has not yet been approved, or because the user has been locked out. In Step 4 we will see how to show a more detailed message to the user when their login attempt fails.</span></span>

## <a name="step-2-collecting-credentials-through-the-login-web-control"></a><span data-ttu-id="d2b52-168">步骤2：通过登录 Web 控件收集凭据</span><span class="sxs-lookup"><span data-stu-id="d2b52-168">Step 2: Collecting Credentials through the Login Web Control</span></span>

<span data-ttu-id="d2b52-169">[登录 Web 控件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)呈现的默认用户界面非常类似于我们在<a id="SKM5"> </a> [*Forms 身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中创建的用户界面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-169">The [Login Web control](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) renders a default user interface very similar to the one we created back in the <a id="SKM5"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial.</span></span> <span data-ttu-id="d2b52-170">使用登录控件，使我们能够创建用于收集访问者凭据的接口。</span><span class="sxs-lookup"><span data-stu-id="d2b52-170">Using the Login control saves us the work of having to create the interface to collect the visitor�s credentials.</span></span> <span data-ttu-id="d2b52-171">而且，登录控件会自动登录用户（假定提交的凭据有效），从而使我们不必编写任何代码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-171">Moreover, the Login control automatically signs in the user (assuming the submitted credentials are valid), thereby saving us from having to write any code.</span></span>

<span data-ttu-id="d2b52-172">让我们更新 `Login.aspx`，将手动创建的接口和代码替换为登录控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-172">Let's update `Login.aspx`, replacing the manually created interface and code with a Login control.</span></span> <span data-ttu-id="d2b52-173">首先，删除 `Login.aspx`中的现有标记和代码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-173">Start by removing the existing markup and code in `Login.aspx`.</span></span> <span data-ttu-id="d2b52-174">您可以完全删除它，或者只是将其注释掉。若要注释声明性标记，请将其括在 `<%--` 和 `--%>` 分隔符。</span><span class="sxs-lookup"><span data-stu-id="d2b52-174">You may delete it outright, or simply comment it out. To comment out declarative markup, surround it with the `<%--` and `--%>` delimiters.</span></span> <span data-ttu-id="d2b52-175">您可以手动输入这些分隔符，或者如图2所示，您可以选择要注释掉的文本，然后单击工具栏中的 "选定的行" 图标注释掉。</span><span class="sxs-lookup"><span data-stu-id="d2b52-175">You can enter these delimiters manually, or, as Figure 2 shows, you may select the text to comment out and then click the Comment out the selected lines icon in the Toolbar.</span></span> <span data-ttu-id="d2b52-176">同样，可以使用注释掉所选的行图标注释掉代码隐藏类中的选定代码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-176">Similarly, you can use the Comment out the selected lines icon to comment out the selected code in the code-behind class.</span></span>

<span data-ttu-id="d2b52-177">[![在 default.aspx 中注释掉现有声明性标记和源代码](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-177">[![Comment Out the Existing Declarative Markup and Source Code in Login.aspx](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span></span>

<span data-ttu-id="d2b52-178">**图 2**：在 `Login.aspx` 中注释掉现有声明性标记和源代码（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-178">**Figure 2**: Comment Out the Existing Declarative Markup and Source Code in `Login.aspx` ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-179">在 Visual Studio 2005 中查看声明性标记时，"注释掉所选行" 图标不可用。</span><span class="sxs-lookup"><span data-stu-id="d2b52-179">The Comment out the selected lines icon is not available when viewing the declarative markup in Visual Studio 2005.</span></span> <span data-ttu-id="d2b52-180">如果未使用 Visual Studio 2008，则需要手动添加 `<%--` 和 `--%>` 分隔符。</span><span class="sxs-lookup"><span data-stu-id="d2b52-180">If you are not using Visual Studio 2008 you will need to manually add the `<%--` and `--%>` delimiters.</span></span>

<span data-ttu-id="d2b52-181">接下来，将 "登录" 控件从 "工具箱" 拖到页面上，然后将其 `ID` 属性设置为 "`myLogin`"。</span><span class="sxs-lookup"><span data-stu-id="d2b52-181">Next, drag a Login control from the Toolbox on to the page and set its `ID` property to `myLogin`.</span></span> <span data-ttu-id="d2b52-182">此时，屏幕应类似于图3所示。</span><span class="sxs-lookup"><span data-stu-id="d2b52-182">At this point your screen should look similar to Figure 3.</span></span> <span data-ttu-id="d2b52-183">请注意，登录控件的默认界面包含 "用户名" 和 "密码" 的 TextBox 控件、"下次记住我" 复选框和 "登录" 按钮。</span><span class="sxs-lookup"><span data-stu-id="d2b52-183">Note that the Login control's default interface includes TextBox controls for the username and password, a Remember me next time CheckBox, and a Log In Button.</span></span> <span data-ttu-id="d2b52-184">这两个文本框还有 `RequiredFieldValidator` 控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-184">There are also `RequiredFieldValidator` controls for the two TextBoxes.</span></span>

<span data-ttu-id="d2b52-185">[![将登录控件添加到页面](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-185">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span></span>

<span data-ttu-id="d2b52-186">**图 3**：将登录控件添加到页面（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-186">**Figure 3**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))</span></span>

<span data-ttu-id="d2b52-187">我们已经完成了！</span><span class="sxs-lookup"><span data-stu-id="d2b52-187">And we're done!</span></span> <span data-ttu-id="d2b52-188">单击登录控件的 "登录" 按钮时，将发生回发，登录控件将调用 `Membership.ValidateUser` 方法，并传入输入的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="d2b52-188">When the Login control's Log In button is clicked, a postback will occur and the Login control will call the `Membership.ValidateUser` method, passing in the entered username and password.</span></span> <span data-ttu-id="d2b52-189">如果凭据无效，登录控件会显示一条消息，指出这样。</span><span class="sxs-lookup"><span data-stu-id="d2b52-189">If the credentials are invalid, the Login control displays a message stating such.</span></span> <span data-ttu-id="d2b52-190">但是，如果凭据有效，则登录控件会创建 forms 身份验证票证，并将用户重定向到相应的页面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-190">If, however, the credentials are valid, then the Login control creates the forms authentication ticket and redirects the user to the appropriate page.</span></span>

<span data-ttu-id="d2b52-191">登录控件使用四个因素来确定成功登录时要将用户重定向到的适当页面：</span><span class="sxs-lookup"><span data-stu-id="d2b52-191">The Login control uses four factors to determine the appropriate page to redirect the user to upon a successful login:</span></span>

- <span data-ttu-id="d2b52-192">登录控件是否位于由 forms 身份验证配置中 `loginUrl` 设置定义的登录页上;此设置的默认值为 `Login.aspx`</span><span class="sxs-lookup"><span data-stu-id="d2b52-192">Whether the Login control is on the login page as defined by `loginUrl` setting in the forms authentication configuration; this setting's default value is `Login.aspx`</span></span>
- <span data-ttu-id="d2b52-193">存在 `ReturnUrl` querystring 参数</span><span class="sxs-lookup"><span data-stu-id="d2b52-193">The presence of a `ReturnUrl` querystring parameter</span></span>
- <span data-ttu-id="d2b52-194">登录控件的[`DestinationUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)的值</span><span class="sxs-lookup"><span data-stu-id="d2b52-194">The value of the Login control's [`DestinationUrl` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)</span></span>
- <span data-ttu-id="d2b52-195">Forms 身份验证配置设置中指定的 `defaultUrl` 值;此设置的默认值为 `Default.aspx`</span><span class="sxs-lookup"><span data-stu-id="d2b52-195">The `defaultUrl` value specified in the forms authentication configuration settings; this setting's default value is `Default.aspx`</span></span>

<span data-ttu-id="d2b52-196">图4描述了登录控件如何使用这四个参数到达其相应的页面决定。</span><span class="sxs-lookup"><span data-stu-id="d2b52-196">Figure 4 depicts the how the Login control uses these four parameters to arrive at its appropriate page decision.</span></span>

<span data-ttu-id="d2b52-197">[![将登录控件添加到页面](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-197">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span></span>

<span data-ttu-id="d2b52-198">**图 4**：将登录控件添加到页面（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-198">**Figure 4**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))</span></span>

<span data-ttu-id="d2b52-199">通过访问浏览器并以成员身份框架中的现有用户身份登录，花点时间测试登录控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-199">Take a moment to test out the Login control by visiting the site through a browser and logging in as an existing user in the Membership framework.</span></span>

<span data-ttu-id="d2b52-200">登录控件的呈现接口具有高度的可配置性。</span><span class="sxs-lookup"><span data-stu-id="d2b52-200">The Login control's rendered interface is highly configurable.</span></span> <span data-ttu-id="d2b52-201">有许多属性会影响其外观;而且，可以将登录控件转换为模板，以便精确地控制用户界面元素的布局。</span><span class="sxs-lookup"><span data-stu-id="d2b52-201">There are a number of properties that influence its appearance; what's more, the Login control can be converted into a template for precise control over the layout the user interface elements.</span></span> <span data-ttu-id="d2b52-202">此步骤的其余部分将检查如何自定义外观和布局。</span><span class="sxs-lookup"><span data-stu-id="d2b52-202">The remainder of this step examines how to customize the appearance and layout.</span></span>

### <a name="customizing-the-login-controls-appearance"></a><span data-ttu-id="d2b52-203">自定义登录控件的外观</span><span class="sxs-lookup"><span data-stu-id="d2b52-203">Customizing the Login Control's Appearance</span></span>

<span data-ttu-id="d2b52-204">登录控件的默认属性设置将使用 "用户名" 和 "密码" 输入的 "用户名" 和 "密码" 输入的 "记住我" 复选框和 "登录" 按钮呈现具有标题（登录）、文本框和标签控件的用户界面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-204">The Login control's default property settings render a user interface with a title ( Log In ), TextBox and Label controls for the username and password inputs, a Remember me next time CheckBox, and a Log In button.</span></span> <span data-ttu-id="d2b52-205">这些元素的外观均可通过登录控件的大量属性进行配置。</span><span class="sxs-lookup"><span data-stu-id="d2b52-205">The appearances of these elements are all configurable through the Login control's numerous properties.</span></span> <span data-ttu-id="d2b52-206">此外，还可以通过设置一个属性或两个来添加其他用户界面元素（例如指向用于创建新用户帐户的页面的链接）。</span><span class="sxs-lookup"><span data-stu-id="d2b52-206">Furthermore, additional user interface elements - such as a link to a page to create a new user account - can be added by setting a property or two.</span></span>

<span data-ttu-id="d2b52-207">让我们花点时间来 gussy 登录控件的外观。</span><span class="sxs-lookup"><span data-stu-id="d2b52-207">Let's spend a few moments to gussy up the appearance of our Login control.</span></span> <span data-ttu-id="d2b52-208">由于 `Login.aspx` 页面的顶部已经显示了 "登录" 页的顶部，因此登录控件的标题是多余的。</span><span class="sxs-lookup"><span data-stu-id="d2b52-208">Since the `Login.aspx` page already has text at the top of the page that says Login, the Login control's title is superfluous.</span></span> <span data-ttu-id="d2b52-209">因此，请清除[`TitleText` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx)值，以便删除登录控件的标题。</span><span class="sxs-lookup"><span data-stu-id="d2b52-209">Therefore, clear out the [`TitleText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) value in order to remove the Login control's title.</span></span>

<span data-ttu-id="d2b52-210">两个 TextBox 控件左侧的 "用户名：" 和 "密码：" 标签分别可通过 " [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) " 和 " [`PasswordLabelText`" 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx)进行自定义。</span><span class="sxs-lookup"><span data-stu-id="d2b52-210">The User Name: and Password: Labels to the left of the two TextBox controls can be customized through the [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) and [`PasswordLabelText` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx), respectively.</span></span> <span data-ttu-id="d2b52-211">让我们更改 "用户名：" 标签以阅读用户名：。</span><span class="sxs-lookup"><span data-stu-id="d2b52-211">Let's change the User Name: Label to read Username:.</span></span> <span data-ttu-id="d2b52-212">标签和文本框样式可分别通过[`LabelStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx)和[`TextBoxStyle` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx)进行配置。</span><span class="sxs-lookup"><span data-stu-id="d2b52-212">The Label and TextBox styles are configurable through the [`LabelStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) and [`TextBoxStyle` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx), respectively.</span></span>

<span data-ttu-id="d2b52-213">"下次记住我" 复选框的文本属性可通过登录控件的[`RememberMeText property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx)进行设置，其默认的选中状态可通过[`RememberMeSet property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) （默认为 False）进行配置。</span><span class="sxs-lookup"><span data-stu-id="d2b52-213">The Remember me next time CheckBox's Text property can be set through the Login control's [`RememberMeText property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx), and its default checked state is configurable through the [`RememberMeSet property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (which defaults to False).</span></span> <span data-ttu-id="d2b52-214">继续操作并将 `RememberMeSet` 属性设置为 True，以便默认选中 "记住我下一次" 复选框。</span><span class="sxs-lookup"><span data-stu-id="d2b52-214">Go ahead and set the `RememberMeSet` property to True so that the Remember me next time CheckBox will be checked by default.</span></span>

<span data-ttu-id="d2b52-215">登录控件提供了两个属性，用于调整其用户界面控件的布局。</span><span class="sxs-lookup"><span data-stu-id="d2b52-215">The Login control offers two properties for adjusting the layout of its user interface controls.</span></span> <span data-ttu-id="d2b52-216">[`TextLayout property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx)指示用户名：和密码：标签是显示在其对应的文本框（默认值）或其上方的左侧。</span><span class="sxs-lookup"><span data-stu-id="d2b52-216">The [`TextLayout property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx) indicates whether the Username: and Password: Labels appear to the left of their corresponding TextBoxes (the default), or above them.</span></span> <span data-ttu-id="d2b52-217">[`Orientation property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx)指示用户名和密码输入是垂直的（在另一个上）还是水平放置。</span><span class="sxs-lookup"><span data-stu-id="d2b52-217">The [`Orientation property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx) indicates whether the username and password inputs are situated vertically (one above the other) or horizontally.</span></span> <span data-ttu-id="d2b52-218">我要使这两个属性设置为其默认值，但是我建议您尝试将这两个属性设置为非默认值，以查看结果结果。</span><span class="sxs-lookup"><span data-stu-id="d2b52-218">I am going to leave these two properties set to their defaults, but I encourage you to try setting these two properties to their non-default values to see the resulting effect.</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-219">在下一部分中，配置登录控件的布局时，我们将介绍如何使用模板定义布局控件的用户界面元素的精确布局。</span><span class="sxs-lookup"><span data-stu-id="d2b52-219">In the next section, Configuring the Login Control's Layout, we will look at using templates to define the precise layout of the Layout control's user interface elements.</span></span>

<span data-ttu-id="d2b52-220">是否通过将[`CreateUserText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx)和[`CreateUserUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx)设置为 "尚未注册" 来将登录控件的属性设置</span><span class="sxs-lookup"><span data-stu-id="d2b52-220">Wrap up the Login control's property settings by setting the [`CreateUserText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) and [`CreateUserUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) to Not registered yet?</span></span> <span data-ttu-id="d2b52-221">创建帐户！</span><span class="sxs-lookup"><span data-stu-id="d2b52-221">Create an account!</span></span> <span data-ttu-id="d2b52-222">和 `~/Membership/CreatingUserAccounts.aspx`。</span><span class="sxs-lookup"><span data-stu-id="d2b52-222">and `~/Membership/CreatingUserAccounts.aspx`, respectively.</span></span> <span data-ttu-id="d2b52-223">这会向登录控件的接口添加一个超链接，该超链接指向在<a id="SKM6"> </a>[上一教程](creating-user-accounts-cs.md)中创建的页面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-223">This adds a hyperlink to the Login control's interface pointing to the page we created in the <a id="SKM6"></a>[preceding tutorial](creating-user-accounts-cs.md).</span></span> <span data-ttu-id="d2b52-224">登录控件的[`HelpPageText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx)和[`HelpPageUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx)以及[`PasswordRecoveryText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx)和[`PasswordRecoveryUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx)的工作方式相同，它将链接到帮助页和密码恢复页。</span><span class="sxs-lookup"><span data-stu-id="d2b52-224">The Login control's [`HelpPageText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) and [`HelpPageUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) and [`PasswordRecoveryText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) and [`PasswordRecoveryUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) work in the same manner, rendering links to a help page and a password recovery page.</span></span>

<span data-ttu-id="d2b52-225">进行这些属性更改后，登录控件的声明性标记和外观应类似于图5所示。</span><span class="sxs-lookup"><span data-stu-id="d2b52-225">After making these property changes, your Login control's declarative markup and appearance should look similar to that shown in Figure 5.</span></span>

<span data-ttu-id="d2b52-226">[![登录控件的属性值决定了其外观](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-226">[![The Login Control's Properties' Values Dictate Its Appearance](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span></span>

<span data-ttu-id="d2b52-227">**图 5**：登录控件的属性值决定了其外观（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-227">**Figure 5**: The Login Control's Properties' Values Dictate Its Appearance  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))</span></span>

### <a name="configuring-the-login-controls-layout"></a><span data-ttu-id="d2b52-228">配置登录控件的布局</span><span class="sxs-lookup"><span data-stu-id="d2b52-228">Configuring the Login Control's Layout</span></span>

<span data-ttu-id="d2b52-229">登录 Web 控件的默认用户界面在 HTML `<table>`中布局界面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-229">The Login Web control's default user interface lays out the interface in an HTML `<table>`.</span></span> <span data-ttu-id="d2b52-230">但如果我们需要更好地控制呈现的输出，该怎么办？</span><span class="sxs-lookup"><span data-stu-id="d2b52-230">But what if we need finer control over the rendered output?</span></span> <span data-ttu-id="d2b52-231">也许我们需要将 `<table>` 替换为一系列 `<div>` 标记。</span><span class="sxs-lookup"><span data-stu-id="d2b52-231">Maybe we want to replace the `<table>` with a series of `<div>` tags.</span></span> <span data-ttu-id="d2b52-232">如果我们的应用程序需要其他凭据进行身份验证，该怎么办？</span><span class="sxs-lookup"><span data-stu-id="d2b52-232">Or what if our application requires additional credentials for authentication?</span></span> <span data-ttu-id="d2b52-233">例如，许多金融网站要求用户不仅提供用户名和密码，还需要提供个人标识号（PIN）或其他标识信息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-233">Many financial websites, for instance, require users to supply not only a username and password, but also a Personal Identification Number (PIN), or other identifying information.</span></span> <span data-ttu-id="d2b52-234">无论原因是什么，都可以将登录控件转换为模板，以便可以显式定义接口的声明性标记。</span><span class="sxs-lookup"><span data-stu-id="d2b52-234">Whatever the reasons may be, it is possible to convert the Login control into a template, from which we can explicitly define the interface's declarative markup.</span></span>

<span data-ttu-id="d2b52-235">我们需要执行两项操作，以便更新登录控件以收集其他凭据：</span><span class="sxs-lookup"><span data-stu-id="d2b52-235">We need to do two things in order to update the Login control to collect additional credentials:</span></span>

1. <span data-ttu-id="d2b52-236">更新登录控件的接口以包含用于收集其他凭据的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-236">Update the Login control's interface to include Web control(s) to collect the additional credentials.</span></span>
2. <span data-ttu-id="d2b52-237">重写登录控件的内部身份验证逻辑，以便仅在用户的用户名和密码有效并且其其他凭据有效时才对其进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="d2b52-237">Override the Login control's internal authentication logic so that a user is only authenticated if their username and password is valid and their additional credentials are valid, too.</span></span>

<span data-ttu-id="d2b52-238">若要完成第一个任务，需要将登录控件转换为模板，并添加必要的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-238">To accomplish the first task, we need to convert the Login control into a template and add the necessary Web controls.</span></span> <span data-ttu-id="d2b52-239">对于第二个任务，可以通过为控件的[`Authenticate` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)创建事件处理程序来取代登录控件的身份验证逻辑。</span><span class="sxs-lookup"><span data-stu-id="d2b52-239">As for the second task, the Login control's authentication logic can be superseded by creating an event handler for the control's [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span>

<span data-ttu-id="d2b52-240">让我们更新登录控件，使其提示用户输入其用户名、密码和电子邮件地址，并且仅当提供的电子邮件地址与文件上的电子邮件地址匹配时才对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="d2b52-240">Let's update the Login control so that it prompts users for their username, password, and email address and only authenticates the user if the email address supplied matches their email address on file.</span></span> <span data-ttu-id="d2b52-241">首先需要将登录控件的接口转换为模板。</span><span class="sxs-lookup"><span data-stu-id="d2b52-241">We first need to convert the Login control's interface to a template.</span></span> <span data-ttu-id="d2b52-242">从登录控件的智能标记中，选择 "转换为模板" 选项。</span><span class="sxs-lookup"><span data-stu-id="d2b52-242">From the Login control's Smart Tag, choose the Convert to template option.</span></span>

<span data-ttu-id="d2b52-243">[![将登录控件转换为模板](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-243">[![Convert the Login Control to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span></span>

<span data-ttu-id="d2b52-244">**图 6**：将登录控件转换为模板（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-244">**Figure 6**: Convert the Login Control to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-245">若要将登录控件恢复为其预模板版本，请单击控件的智能标记中的 "重置" 链接。</span><span class="sxs-lookup"><span data-stu-id="d2b52-245">To revert the Login control to its pre-template version, click the Reset link from the control's Smart Tag.</span></span>

<span data-ttu-id="d2b52-246">将登录控件转换为模板会将 `LayoutTemplate` 添加到控件的声明性标记中，其中包含 HTML 元素和定义用户界面的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-246">Converting the Login control to a template adds a `LayoutTemplate` to the control's declarative markup with HTML elements and Web controls defining the user interface.</span></span> <span data-ttu-id="d2b52-247">如图7所示，将控件转换为模板会从属性窗口中移除许多属性，如 `TitleText`、`CreateUserUrl`等，因为在使用模板时将忽略这些属性值。</span><span class="sxs-lookup"><span data-stu-id="d2b52-247">As Figure 7 shows, converting the control to a template removes a number of properties from the Properties window, such as `TitleText`, `CreateUserUrl`, and so forth, since these property values are ignored when using a template.</span></span>

<span data-ttu-id="d2b52-248">[当登录控件转换为模板时，![更少的属性可用](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-248">[![Fewer Properties are Available When the Login Control is Converted to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span></span>

<span data-ttu-id="d2b52-249">**图 7**：将登录控件转换为模板时的可用属性更少（[单击查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-249">**Figure 7**: Fewer Properties are Available When the Login Control is Converted to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))</span></span>

<span data-ttu-id="d2b52-250">`LayoutTemplate` 中的 HTML 标记可以根据需要进行修改。</span><span class="sxs-lookup"><span data-stu-id="d2b52-250">The HTML markup in the `LayoutTemplate` may be modified as needed.</span></span> <span data-ttu-id="d2b52-251">同样，也可以随意将任何新的 Web 控件添加到模板。</span><span class="sxs-lookup"><span data-stu-id="d2b52-251">Likewise, feel free to add any new Web controls to the template.</span></span> <span data-ttu-id="d2b52-252">但重要的是，登录控件的核心 Web 控件保留在模板中，并将其分配 `ID` 值。</span><span class="sxs-lookup"><span data-stu-id="d2b52-252">However, it is important that Login control's core Web controls remain in the template and keep their assigned `ID` values.</span></span> <span data-ttu-id="d2b52-253">特别是，不要删除或重命名 `UserName` 或 `Password` 文本框、"`RememberMe`" 复选框、"`LoginButton`" 按钮、"`FailureText`" 标签或 `RequiredFieldValidator` 控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-253">In particular, do not remove or rename the `UserName` or `Password` TextBoxes, the `RememberMe` CheckBox, the `LoginButton` Button, the `FailureText` Label, or the `RequiredFieldValidator` controls.</span></span>

<span data-ttu-id="d2b52-254">若要收集访问者的电子邮件地址，需要在模板中添加一个文本框。</span><span class="sxs-lookup"><span data-stu-id="d2b52-254">To collect the visitor's email address, we need to add a TextBox to the template.</span></span> <span data-ttu-id="d2b52-255">在包含 "`Password`" 文本框的表行（`<tr>`）和保留 "下次记住我" 复选框的表行之间添加以下声明性标记：</span><span class="sxs-lookup"><span data-stu-id="d2b52-255">Add the following declarative markup between the table row (`<tr>`) that contains the `Password` TextBox and the table row that holds the Remember me next time CheckBox:</span></span>

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample2.aspx)]

<span data-ttu-id="d2b52-256">添加 "`Email`" 文本框后，请通过浏览器访问此页。</span><span class="sxs-lookup"><span data-stu-id="d2b52-256">After adding the `Email` TextBox, visit the page through a browser.</span></span> <span data-ttu-id="d2b52-257">如图8所示，登录控件的用户界面现在包含第三个文本框。</span><span class="sxs-lookup"><span data-stu-id="d2b52-257">As Figure 8 shows, the Login control's user interface now includes a third textbox.</span></span>

<span data-ttu-id="d2b52-258">[![登录控件现在包含用户电子邮件地址的文本框](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-258">[![The Login Control Now Includes a Textbox for the User's Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span></span>

<span data-ttu-id="d2b52-259">**图 8**：登录控件现在包含用户电子邮件地址的文本框（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-259">**Figure 8**: The Login Control Now Includes a Textbox for the User's Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))</span></span>

<span data-ttu-id="d2b52-260">此时，登录控件仍使用 `Membership.ValidateUser` 方法来验证提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-260">At this point, the Login control is still using the `Membership.ValidateUser` method to validate the supplied credentials.</span></span> <span data-ttu-id="d2b52-261">同样，在 "`Email`" 文本框中输入的值与用户是否可以登录无关。</span><span class="sxs-lookup"><span data-stu-id="d2b52-261">Correspondingly, the value entered into the `Email` TextBox has no bearing on whether the user can log in.</span></span> <span data-ttu-id="d2b52-262">在步骤3中，我们将介绍如何替代登录控件的身份验证逻辑，以便仅在用户名和密码有效并且所提供的电子邮件地址与文件上的电子邮件地址匹配时才将凭据视为有效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-262">In Step 3 we will look at how to override the Login control's authentication logic so that the credentials are only considered valid if the username and password are valid and the supplied email address matches up with the email address on file.</span></span>

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a><span data-ttu-id="d2b52-263">步骤3：修改登录控件的身份验证逻辑</span><span class="sxs-lookup"><span data-stu-id="d2b52-263">Step 3: Modifying the Login Control's Authentication Logic</span></span>

<span data-ttu-id="d2b52-264">当访问者提供自己的凭据并单击 "登录" 按钮时，回发可以和登录控件会通过其身份验证工作流进行。</span><span class="sxs-lookup"><span data-stu-id="d2b52-264">When a visitor supplies her credentials and clicks the Log In button, a postback ensues and the Login control progresses through its authentication workflow.</span></span> <span data-ttu-id="d2b52-265">工作流首先引发[`LoggingIn` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx)。</span><span class="sxs-lookup"><span data-stu-id="d2b52-265">The workflow starts by raising the [`LoggingIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx).</span></span> <span data-ttu-id="d2b52-266">与此事件关联的任何事件处理程序都可以通过将 `e.Cancel` 属性设置为 `true`来取消登录操作。</span><span class="sxs-lookup"><span data-stu-id="d2b52-266">Any event handlers associated with this event may cancel the log in operation by setting the `e.Cancel` property to `true`.</span></span>

<span data-ttu-id="d2b52-267">如果未取消登录操作，则工作流将通过引发[`Authenticate` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)进行。</span><span class="sxs-lookup"><span data-stu-id="d2b52-267">If the log in operation is not cancelled, the workflow progresses by raising the [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span> <span data-ttu-id="d2b52-268">如果有 `Authenticate` 事件的事件处理程序，则负责确定所提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-268">If there is an event handler for the `Authenticate` event, then it is responsible for determining whether the supplied credentials are valid or not.</span></span> <span data-ttu-id="d2b52-269">如果未指定任何事件处理程序，则登录控件将使用 `Membership.ValidateUser` 方法来确定凭据的有效性。</span><span class="sxs-lookup"><span data-stu-id="d2b52-269">If no event handler is specified, the Login control uses the `Membership.ValidateUser` method to determine the validity of the credentials.</span></span>

<span data-ttu-id="d2b52-270">如果提供的凭据有效，则创建 forms 身份验证票证，引发[`LoggedIn` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx)，并将用户重定向到相应的页面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-270">If the supplied credentials are valid, then the forms authentication ticket is created, the [`LoggedIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) is raised, and the user is redirected to the appropriate page.</span></span> <span data-ttu-id="d2b52-271">但是，如果凭据被视为无效，则会引发[`LoginError` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx)，并显示一条消息，告知用户其凭据无效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-271">If, however, the credentials are deemed invalid, then the [`LoginError` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) is raised and a message is displayed informing the user that their credentials were invalid.</span></span> <span data-ttu-id="d2b52-272">默认情况下，在失败时，登录控件只需将其 `FailureText` 标签控件的 Text 属性设置为失败消息（登录尝试不成功。</span><span class="sxs-lookup"><span data-stu-id="d2b52-272">By default, on failure the Login control simply sets its `FailureText` Label control's Text property to a failure message ( Your login attempt was not successful.</span></span> <span data-ttu-id="d2b52-273">请重试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-273">Please try again ).</span></span> <span data-ttu-id="d2b52-274">但是，如果将登录控件的[`FailureAction` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx)设置为 `RedirectToLoginPage`，则登录控件会向登录页发出 `Response.Redirect`，并追加 querystring 参数 `loginfailure=1` （这会导致登录控件显示失败消息）。</span><span class="sxs-lookup"><span data-stu-id="d2b52-274">However, if the Login control's [`FailureAction` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) is set to `RedirectToLoginPage`, then the Login control issues a `Response.Redirect` to the login page appending the querystring parameter `loginfailure=1` (which causes the Login control to display the failure message).</span></span>

<span data-ttu-id="d2b52-275">图9提供身份验证工作流的流程图。</span><span class="sxs-lookup"><span data-stu-id="d2b52-275">Figure 9 offers a flow chart of the authentication workflow.</span></span>

<span data-ttu-id="d2b52-276">[![登录控件的身份验证工作流](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-276">[![The Login Control's Authentication Workflow](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span></span>

<span data-ttu-id="d2b52-277">**图 9**：登录控件的身份验证工作流（[单击以查看完全大小的映像](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-277">**Figure 9**: The Login Control's Authentication Workflow  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-278">如果您想知道何时使用 `FailureAction`的 `RedirectToLogin` 页选项，请考虑以下方案。</span><span class="sxs-lookup"><span data-stu-id="d2b52-278">If you are wondering when you would use the `FailureAction`'s `RedirectToLogin` page option, consider the following scenario.</span></span> <span data-ttu-id="d2b52-279">现在，当匿名用户访问时，`Site.master` 母版页当前包含在左列中显示的文本 stranger，但假设我们想要将该文本替换为登录控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-279">Right now our `Site.master` master page currently has the text, Hello, stranger displayed in the left column when visited by an anonymous user, but imagine that we wanted to replace that text with a Login control.</span></span> <span data-ttu-id="d2b52-280">这将允许匿名用户从网站上的任何页面登录，而不需要他们直接访问登录页。</span><span class="sxs-lookup"><span data-stu-id="d2b52-280">This would allow an anonymous user to log in from any page on the site, instead of requiring them to visit the login page directly.</span></span> <span data-ttu-id="d2b52-281">但是，如果用户无法通过母版页呈现的登录控件登录，则可以将它们重定向到登录页（`Login.aspx`），因为该页面可能包括其他说明、链接和其他帮助，例如，用于创建新帐户或检索丢失密码的链接（未添加到母版页中）。</span><span class="sxs-lookup"><span data-stu-id="d2b52-281">However, if a user was unable to log in via the Login control rendered by the master page, it might make sense to redirect them to the login page (`Login.aspx`) because that page likely includes additional instructions, links, and other help - such as links to create a new account or retrieve a lost password - that were not added to the master page.</span></span>

### <a name="creating-theauthenticateevent-handler"></a><span data-ttu-id="d2b52-282">创建`Authenticate`事件处理程序</span><span class="sxs-lookup"><span data-stu-id="d2b52-282">Creating the`Authenticate`Event Handler</span></span>

<span data-ttu-id="d2b52-283">为了插入自定义身份验证逻辑，需要为登录控件的 `Authenticate` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="d2b52-283">In order to plug in our custom authentication logic, we need to create an event handler for the Login control's `Authenticate` event.</span></span> <span data-ttu-id="d2b52-284">为 `Authenticate` 事件创建事件处理程序将生成以下事件处理程序定义：</span><span class="sxs-lookup"><span data-stu-id="d2b52-284">Creating an event handler for the `Authenticate` event will generate the following event handler definition:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample3.cs)]

<span data-ttu-id="d2b52-285">正如您所看到的，`Authenticate` 事件处理程序将[`AuthenticateEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx)类型的对象作为它的第二个输入参数传递。</span><span class="sxs-lookup"><span data-stu-id="d2b52-285">As you can see, the `Authenticate` event handler is passed an object of type [`AuthenticateEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) as its second input parameter.</span></span> <span data-ttu-id="d2b52-286">`AuthenticateEventArgs` 类包含一个名为 `Authenticated` 的布尔值属性，该属性用于指定提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="d2b52-286">The `AuthenticateEventArgs` class contains a Boolean property named `Authenticated` that is used to specify whether the supplied credentials are valid.</span></span> <span data-ttu-id="d2b52-287">然后，我们的任务是在此处编写代码来确定所提供的凭据是否有效，并相应地设置 `e.Authenticate` 属性。</span><span class="sxs-lookup"><span data-stu-id="d2b52-287">Our task, then, is to write code here that determines whether the supplied credentials are valid or not, and to set the `e.Authenticate` property accordingly.</span></span>

### <a name="determining-and-validating-the-supplied-credentials"></a><span data-ttu-id="d2b52-288">确定和验证提供的凭据</span><span class="sxs-lookup"><span data-stu-id="d2b52-288">Determining and Validating the Supplied Credentials</span></span>

<span data-ttu-id="d2b52-289">使用登录控件的[`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx)和[`Password` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx)来确定用户输入的用户名和密码凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-289">Use the Login control's [`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) and [`Password` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) to determine the username and password credentials entered by the user.</span></span> <span data-ttu-id="d2b52-290">若要确定输入到任何其他 Web 控件（例如在上一步中添加的 `Email` 文本框）中输入的值，请使用 *`LoginControlID`* `.FindControl`（" *`controlID`* "）来获取对模板中的 Web 控件的编程引用，其 `ID` 属性等于 *`controlID`* 。</span><span class="sxs-lookup"><span data-stu-id="d2b52-290">In order to determine the values entered into any additional Web controls (such as the `Email` TextBox we added in the previous step), use *`LoginControlID`*`.FindControl`("*`controlID`*") to obtain a programmatic reference to the Web control in the template whose `ID` property is equal to *`controlID`*.</span></span> <span data-ttu-id="d2b52-291">例如，若要获取对 `Email` 文本框的引用，请使用以下代码：</span><span class="sxs-lookup"><span data-stu-id="d2b52-291">For example, to get a reference to the `Email` TextBox, use the following code:</span></span>

`TextBox EmailTextBox = myLogin.FindControl("Email") as TextBox;`

<span data-ttu-id="d2b52-292">若要验证用户的凭据，需要执行两项操作：</span><span class="sxs-lookup"><span data-stu-id="d2b52-292">In order to validate the user's credentials we need to do two things:</span></span>

1. <span data-ttu-id="d2b52-293">确保提供的用户名和密码有效</span><span class="sxs-lookup"><span data-stu-id="d2b52-293">Ensure that the provided username and password are valid</span></span>
2. <span data-ttu-id="d2b52-294">确保输入的电子邮件地址与尝试登录的用户的文件中的电子邮件地址匹配</span><span class="sxs-lookup"><span data-stu-id="d2b52-294">Ensure that email address entered matches the email address on file for the user attempting to log in</span></span>

<span data-ttu-id="d2b52-295">若要完成第一次检查，只需使用 `Membership.ValidateUser` 方法，就像我们在步骤1中看到的那样。</span><span class="sxs-lookup"><span data-stu-id="d2b52-295">To accomplish the first check we can simply use the `Membership.ValidateUser` method like we saw in Step 1.</span></span> <span data-ttu-id="d2b52-296">对于第二个检查，需要确定用户的电子邮件地址，以便我们可以将其与在 TextBox 控件中输入的电子邮件地址进行比较。</span><span class="sxs-lookup"><span data-stu-id="d2b52-296">For the second check, we need to determine the user's email address so that we can compare it to the email address they entered into the TextBox control.</span></span> <span data-ttu-id="d2b52-297">若要获取有关特定用户的信息，请使用 `Membership` 类的[`GetUser` 方法](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="d2b52-297">To get information about a particular user, use the `Membership` class's [`GetUser` method](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx).</span></span>

<span data-ttu-id="d2b52-298">`GetUser` 方法有很多重载。</span><span class="sxs-lookup"><span data-stu-id="d2b52-298">The `GetUser` method has a number of overloads.</span></span> <span data-ttu-id="d2b52-299">如果在不传递任何参数的情况下使用，则它将返回有关当前已登录用户的信息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-299">If used without passing in any parameters, it returns information about the currently logged in user.</span></span> <span data-ttu-id="d2b52-300">若要获取有关特定用户的信息，请调用 `GetUser` 传入用户名。</span><span class="sxs-lookup"><span data-stu-id="d2b52-300">To get information about a particular user, call `GetUser` passing in their username.</span></span> <span data-ttu-id="d2b52-301">无论采用哪种方式，`GetUser` 都将返回一个[`MembershipUser` 对象](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)，该对象的属性如 `UserName`、`Email`、`IsApproved`、`IsOnline`等。</span><span class="sxs-lookup"><span data-stu-id="d2b52-301">Either way, `GetUser` returns a [`MembershipUser` object](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), which has properties like `UserName`, `Email`, `IsApproved`, `IsOnline`, and so on.</span></span>

<span data-ttu-id="d2b52-302">下面的代码实现了这两个检查。</span><span class="sxs-lookup"><span data-stu-id="d2b52-302">The following code implements these two checks.</span></span> <span data-ttu-id="d2b52-303">如果通过，则将 `e.Authenticate` 设置为 `true`，否则将为其分配 `false`。</span><span class="sxs-lookup"><span data-stu-id="d2b52-303">If both pass, then `e.Authenticate` is set to `true`, otherwise it is assigned `false`.</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample4.cs)]

<span data-ttu-id="d2b52-304">使用此代码后，尝试以有效用户的身份登录，并输入正确的用户名、密码和电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="d2b52-304">With this code in place, attempt to log in as a valid user, entering the correct username, password, and email address.</span></span> <span data-ttu-id="d2b52-305">再次尝试此方法，但这一次有意使用错误的电子邮件地址（请参阅图10）。</span><span class="sxs-lookup"><span data-stu-id="d2b52-305">Try it again, but this time purposefully use an incorrect email address (see Figure 10).</span></span> <span data-ttu-id="d2b52-306">最后，使用不存在的用户名进行第三次尝试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-306">Finally, try it a third time using a non-existent username.</span></span> <span data-ttu-id="d2b52-307">在第一种情况下，应成功登录到站点，但在最后两种情况下，应会看到登录控件的无效凭据消息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-307">In the first case you should be successfully logged on to the site, but in the last two cases you should see the Login control's invalid credentials message.</span></span>

<span data-ttu-id="d2b52-308">[提供不正确的电子邮件地址时，![Tito 无法登录](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-308">[![Tito Cannot Log In When Supplying an Incorrect Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span></span>

<span data-ttu-id="d2b52-309">**图 10**：当提供不正确的电子邮件地址时，Tito 无法登录（[单击以查看完全大小的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-309">**Figure 10**: Tito Cannot Log In When Supplying an Incorrect Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))</span></span>

> [!NOTE]
> <span data-ttu-id="d2b52-310">如在步骤1中，成员身份框架如何处理无效的登录尝试部分中所述，当调用 `Membership.ValidateUser` 方法并且传递的凭据无效时，它将跟踪无效的登录尝试并锁定用户，前提是在指定的时间范围内超过特定阈值的无效尝试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-310">As discussed in the How the Membership Framework Handles Invalid Login Attempts section in Step 1, when the `Membership.ValidateUser` method is called and passed invalid credentials, it keeps track of the invalid login attempt and locks out the user if they exceed a certain threshold of invalid attempts within a specified time window.</span></span> <span data-ttu-id="d2b52-311">由于自定义身份验证逻辑调用 `ValidateUser` 方法，因此有效用户名的密码不正确将增加无效的登录尝试计数器，但如果用户名和密码有效，但电子邮件地址不正确，则此计数器不会增加。</span><span class="sxs-lookup"><span data-stu-id="d2b52-311">Since our custom authentication logic calls the `ValidateUser` method, an incorrect password for a valid username will increment the invalid login attempt counter, but this counter is not incremented in the case where the username and password are valid, but the email address is incorrect.</span></span> <span data-ttu-id="d2b52-312">此行为很可能适用，因为黑客不太可能知道用户名和密码，而需要使用暴力破解技术来确定用户的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="d2b52-312">Chances are, this behavior is suitable, since it's unlikely that a hacker will know the username and password, but have to use brute force techniques to determine the user's email address.</span></span>

## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a><span data-ttu-id="d2b52-313">步骤4：提高登录控件的无效凭据消息</span><span class="sxs-lookup"><span data-stu-id="d2b52-313">Step 4: Improving the Login Control's Invalid Credentials Message</span></span>

<span data-ttu-id="d2b52-314">当用户尝试使用无效凭据登录时，登录控件会显示一条消息，说明登录尝试失败。</span><span class="sxs-lookup"><span data-stu-id="d2b52-314">When a user attempts to log on with invalid credentials, the Login control displays a message explaining that the login attempt was unsuccessful.</span></span> <span data-ttu-id="d2b52-315">具体而言，控件显示由其[`FailureText` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx)指定的消息，该属性的默认值为登录尝试失败。</span><span class="sxs-lookup"><span data-stu-id="d2b52-315">In particular, the control displays the message specified by its [`FailureText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), which has a default value of Your login attempt was not successful.</span></span> <span data-ttu-id="d2b52-316">请稍后重试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-316">Please try again.</span></span>

<span data-ttu-id="d2b52-317">回忆一下，用户的凭据可能无效的原因有很多：</span><span class="sxs-lookup"><span data-stu-id="d2b52-317">Recall that there are many reasons why a user's credentials may be invalid:</span></span>

- <span data-ttu-id="d2b52-318">用户名可能不存在</span><span class="sxs-lookup"><span data-stu-id="d2b52-318">The username may not exist</span></span>
- <span data-ttu-id="d2b52-319">用户名存在，但密码无效</span><span class="sxs-lookup"><span data-stu-id="d2b52-319">The username exists, but the password is invalid</span></span>
- <span data-ttu-id="d2b52-320">用户名和密码有效，但用户尚未获得批准</span><span class="sxs-lookup"><span data-stu-id="d2b52-320">The username and password are valid, but the user is not yet approved</span></span>
- <span data-ttu-id="d2b52-321">用户名和密码有效，但用户被锁定（很可能是因为它们超过指定时间范围内的无效登录尝试次数）</span><span class="sxs-lookup"><span data-stu-id="d2b52-321">The username and password are valid, but the user is locked out (most likely because they exceeded the number of invalid login attempts within the specified time frame)</span></span>

<span data-ttu-id="d2b52-322">使用自定义身份验证逻辑时，可能还有其他原因。</span><span class="sxs-lookup"><span data-stu-id="d2b52-322">And there may be other reasons when using custom authentication logic.</span></span> <span data-ttu-id="d2b52-323">例如，在步骤3中编写的代码中，用户名和密码可能是有效的，但电子邮件地址可能不正确。</span><span class="sxs-lookup"><span data-stu-id="d2b52-323">For example, with the code we wrote in Step 3, the username and password may be valid, but the email address may be incorrect.</span></span>

<span data-ttu-id="d2b52-324">无论凭据为何无效，登录控件都将显示相同的错误消息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-324">Regardless of why the credentials are invalid, the Login control displays the same error message.</span></span> <span data-ttu-id="d2b52-325">如果用户的帐户尚未获得批准或已被锁定，则缺乏反馈可能会造成混淆。不过，有一点工作，我们可以让登录控件显示更适当的消息。</span><span class="sxs-lookup"><span data-stu-id="d2b52-325">This lack of feedback can be confusing for a user whose account has not yet been approved or who has been locked out. With a little bit of work, though, we can have the Login control display a more appropriate message.</span></span>

<span data-ttu-id="d2b52-326">每当用户尝试使用无效凭据登录时，登录控件会引发其 `LoginError` 事件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-326">Whenever a user attempts to login with invalid credentials the Login control raises its `LoginError` event.</span></span> <span data-ttu-id="d2b52-327">继续操作并为此事件创建事件处理程序，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="d2b52-327">Go ahead and create an event handler for this event, and add the following code:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample5.cs)]

<span data-ttu-id="d2b52-328">上述代码首先将登录控件的 `FailureText` 属性设置为默认值（登录尝试不成功。</span><span class="sxs-lookup"><span data-stu-id="d2b52-328">The above code starts by setting the Login control's `FailureText` property to the default value ( Your login attempt was not successful.</span></span> <span data-ttu-id="d2b52-329">请重试。</span><span class="sxs-lookup"><span data-stu-id="d2b52-329">Please try again ).</span></span> <span data-ttu-id="d2b52-330">然后，它会检查提供的用户名是否映射到现有的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="d2b52-330">It then checks to see if the username supplied maps to an existing user account.</span></span> <span data-ttu-id="d2b52-331">如果是这样，它将咨询生成的 `MembershipUser` 对象的 `IsLockedOut` 并 `IsApproved` 属性，以确定该帐户是否已锁定或尚未获得批准。</span><span class="sxs-lookup"><span data-stu-id="d2b52-331">If so, it consults the resulting `MembershipUser` object's `IsLockedOut` and `IsApproved` properties to determine if the account has been locked out or has not yet been approved.</span></span> <span data-ttu-id="d2b52-332">在任一情况下，`FailureText` 属性都将更新为相应的值。</span><span class="sxs-lookup"><span data-stu-id="d2b52-332">In either case, the `FailureText` property is updated to a corresponding value.</span></span>

<span data-ttu-id="d2b52-333">若要测试此代码，有意尝试以现有用户身份登录，但使用的密码不正确。</span><span class="sxs-lookup"><span data-stu-id="d2b52-333">To test this code, purposefully attempt to log in as an existing user, but use an incorrect password.</span></span> <span data-ttu-id="d2b52-334">请在10分钟时间范围内的行中执行此操作，该帐户将被锁定。如图11所示，后续登录尝试始终会失败（即使密码正确），但现在会显示更具描述性的信息，因为尝试无效的登录尝试次数过多。</span><span class="sxs-lookup"><span data-stu-id="d2b52-334">Do this five times in a row within a 10 minute time frame and the account will be locked out. As Figure 11 shows, subsequent login attempts will always fail (even with the correct password), but will now display the more descriptive Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="d2b52-335">请与管理员联系，让你的帐户解除锁定。</span><span class="sxs-lookup"><span data-stu-id="d2b52-335">Please contact the administrator to have your account unlocked message.</span></span>

<span data-ttu-id="d2b52-336">[![Tito 执行了太多无效的登录尝试并且已被锁定](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="d2b52-336">[![Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span></span>

<span data-ttu-id="d2b52-337">**图 11**： Tito 执行了过多无效的登录尝试并且已被锁定（[单击以查看完全大小的映像](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png)）</span><span class="sxs-lookup"><span data-stu-id="d2b52-337">**Figure 11**: Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))</span></span>

## <a name="summary"></a><span data-ttu-id="d2b52-338">总结</span><span class="sxs-lookup"><span data-stu-id="d2b52-338">Summary</span></span>

<span data-ttu-id="d2b52-339">在本教程之前，我们的登录页根据用户名/密码对的硬编码列表验证了提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-339">Prior this tutorial, our login page validated the supplied credentials against a hard-coded list of username/password pairs.</span></span> <span data-ttu-id="d2b52-340">在本教程中，我们更新了页面，以根据成员身份框架验证凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-340">In this tutorial, we updated the page to validate credentials against the Membership framework.</span></span> <span data-ttu-id="d2b52-341">在步骤1中，我们查看了以编程方式使用 `Membership.ValidateUser` 方法。</span><span class="sxs-lookup"><span data-stu-id="d2b52-341">In Step 1 we looked at using the `Membership.ValidateUser` method programmatically.</span></span> <span data-ttu-id="d2b52-342">在步骤2中，我们将手动创建的用户界面和代码替换为登录控件。</span><span class="sxs-lookup"><span data-stu-id="d2b52-342">In Step 2 we replaced our manually created user interface and code with the Login control.</span></span>

<span data-ttu-id="d2b52-343">登录控件将呈现标准登录用户界面，并根据成员身份框架自动验证用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="d2b52-343">The Login control renders a standard login user interface and automatically validates the user's credentials against the Membership framework.</span></span> <span data-ttu-id="d2b52-344">此外，在出现有效凭据时，登录控件会通过 forms 身份验证对用户进行签名。</span><span class="sxs-lookup"><span data-stu-id="d2b52-344">Moreover, in the event of valid credentials, the Login control signs the user in via forms authentication.</span></span> <span data-ttu-id="d2b52-345">简而言之，只需将登录控件拖到页面上，无需额外的声明性标记或代码，即可获得功能齐全的登录用户体验。</span><span class="sxs-lookup"><span data-stu-id="d2b52-345">In short, a fully functional login user experience is available by simply dragging the Login control onto a page, no extra declarative markup or code necessary.</span></span> <span data-ttu-id="d2b52-346">而且，登录控件可高度自定义，允许对呈现的用户界面和身份验证逻辑进行精细的控制。</span><span class="sxs-lookup"><span data-stu-id="d2b52-346">What's more, the Login control is highly customizable, allowing for a fine degree of control over both the rendered user interface and authentication logic.</span></span>

<span data-ttu-id="d2b52-347">此时，我们的网站的访问者可以创建新的用户帐户并登录到站点，但我们仍需要根据经过身份验证的用户来限制对页面的访问。</span><span class="sxs-lookup"><span data-stu-id="d2b52-347">At this point visitors to our website can create a new user account and log into the site, but we have yet to look at restricting access to pages based on the authenticated user.</span></span> <span data-ttu-id="d2b52-348">目前，任何经过身份验证或匿名的用户都可以查看网站上的任何页面。</span><span class="sxs-lookup"><span data-stu-id="d2b52-348">Currently, any user, authenticated or anonymous, can view any page on our site.</span></span> <span data-ttu-id="d2b52-349">除了控制每个用户对网站页面的访问权限，我们可能会有某些页面的功能依赖于用户。</span><span class="sxs-lookup"><span data-stu-id="d2b52-349">Along with controlling access to our site's pages on a user-by-user basis, we might have certain pages whose functionality depends on the user.</span></span> <span data-ttu-id="d2b52-350">下一教程介绍了如何基于登录用户限制访问权限和页面内功能。</span><span class="sxs-lookup"><span data-stu-id="d2b52-350">The next tutorial looks at how to limit access and in-page functionality based on the logged in user.</span></span>

<span data-ttu-id="d2b52-351">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="d2b52-351">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="d2b52-352">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="d2b52-352">Further Reading</span></span>

<span data-ttu-id="d2b52-353">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="d2b52-353">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="d2b52-354">显示要锁定的和未批准的用户的自定义消息</span><span class="sxs-lookup"><span data-stu-id="d2b52-354">Displaying Custom Messages to Locked Out and Non-Approved Users</span></span>](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [<span data-ttu-id="d2b52-355">检查 ASP.NET 2.0 的成员资格、角色和配置文件</span><span class="sxs-lookup"><span data-stu-id="d2b52-355">Examining ASP.NET 2.0's Membership, Roles, and Profile</span></span>](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [<span data-ttu-id="d2b52-356">如何：创建 ASP.NET 登录页</span><span class="sxs-lookup"><span data-stu-id="d2b52-356">How To: Create an ASP.NET Login Page</span></span>](https://msdn.microsoft.com/library/ms178331.aspx)
- [<span data-ttu-id="d2b52-357">登录控件技术文档</span><span class="sxs-lookup"><span data-stu-id="d2b52-357">Login Control Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [<span data-ttu-id="d2b52-358">使用登录控件</span><span class="sxs-lookup"><span data-stu-id="d2b52-358">Using the Login Controls</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a><span data-ttu-id="d2b52-359">关于作者</span><span class="sxs-lookup"><span data-stu-id="d2b52-359">About the Author</span></span>

<span data-ttu-id="d2b52-360">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="d2b52-360">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d2b52-361">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="d2b52-361">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d2b52-362">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="d2b52-362">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="d2b52-363">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="d2b52-363">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="d2b52-364">特别感谢</span><span class="sxs-lookup"><span data-stu-id="d2b52-364">Special Thanks To</span></span>

<span data-ttu-id="d2b52-365">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="d2b52-365">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="d2b52-366">本教程的主管评审者是 Teresa Murphy 和 Michael Olivero。</span><span class="sxs-lookup"><span data-stu-id="d2b52-366">Lead reviewers for this tutorial were Teresa Murphy and Michael Olivero.</span></span> <span data-ttu-id="d2b52-367">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="d2b52-367">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="d2b52-368">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com)放置一行。</span><span class="sxs-lookup"><span data-stu-id="d2b52-368">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d2b52-369">[上一页](creating-user-accounts-cs.md)
> [下一页](user-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="d2b52-369">[Previous](creating-user-accounts-cs.md)
[Next](user-based-authorization-cs.md)</span></span>
